version: "3.8"

# ============================================================================
# üöÄ STACK NEXT.JS - D√©ploiement depuis GitHub
# ============================================================================
#
# Cette stack d√©ploie une application Next.js en la r√©cup√©rant depuis GitHub.
#
# M√âTHODE 1 : D√©ploiement via Portainer (Recommand√©)
# ----------------------------------------------------
# Dans Portainer :
# 1. Stacks ‚Üí Add Stack
# 2. Build method : "Repository" (au lieu de "Web editor")
# 3. Repository URL : https://github.com/votre-username/votre-repo
# 4. Repository reference : main (ou master)
# 5. Compose path : nextjs-stack-github.yaml
# 6. Deploy
#
# M√âTHODE 2 : D√©ploiement via CLI
# --------------------------------
# git clone https://github.com/votre-username/votre-repo.git
# cd votre-repo
# docker-compose -f nextjs-stack-github.yaml up -d --build
#
# ============================================================================

services:
    # --- Application Next.js ---
    sembresjero-me:
        # Build depuis le r√©pertoire courant (clon√© par Portainer ou Git)
        build:
            context: .
            dockerfile: Dockerfile
            args:
                NODE_ENV: production

        image: sembresjero-me:latest
        container_name: "sembresjero-me"
        restart: unless-stopped

        environment:
            # --- Configuration Next.js ---
            NODE_ENV: "production"
            PORT: 3000
            HOST: "0.0.0.0"

            # --- Fuseau horaire ---
            TZ: "Europe/Paris"

            # ============================================================
            # ‚ö†Ô∏è S√âCURIT√â : NE PAS METTRE DE CREDENTIALS ICI !
            # ============================================================
            #
            # Les variables sensibles (mots de passe, cl√©s API, secrets)
            # doivent √™tre configur√©es dans Portainer, PAS dans ce fichier !
            #
            # Dans Portainer : Stack ‚Üí Environment variables
            #
            # Exemples de variables √† configurer dans Portainer :
            # - DATABASE_URL
            # - REDIS_URL
            # - API_SECRET_KEY
            # - NEXTAUTH_SECRET
            # - SMTP_PASSWORD
            # - AWS_SECRET_ACCESS_KEY
            #
            # Variables publiques non-sensibles (OK dans ce fichier) :
            # NEXT_PUBLIC_API_URL: "https://api.example.com"
            # NEXTAUTH_URL: "https://app.example.com"
            #
            # ============================================================

        networks:
            - proxy-net

        # Health check (utilise Node.js car curl n'est pas install√© dans Alpine)
        #healthcheck:
        #    test:
        #        [
        #            "CMD",
        #            "node",
        #            "-e",
        #            "require('http').get('http://localhost:3000/', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        #        ]
        #    interval: 30s
        #    timeout: 10s
        #    retries: 3
        #    start_period: 60s

        labels:
            - "com.portainer.description=Portfolio de J√©r√¥me Sembres en Next.js depuis GitHub"
            - "com.portainer.backup=false"

        # Limites de ressources
        deploy:
            resources:
                limits:
                    cpus: "2.0"
                    memory: 2G
                reservations:
                    cpus: "0.5"
                    memory: 512M

        # Volumes optionnels (si vous avez des uploads, etc.)
        # volumes:
        #     - nextjs_uploads:/app/public/uploads
        #     - nextjs_data:/app/data

# --- D√©finition des ressources ---

networks:
    proxy-net:
        external: true
